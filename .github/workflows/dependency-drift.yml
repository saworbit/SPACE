name: Dependency Drift

on:
  schedule:
    - cron: "0 5 * * *"
  workflow_dispatch:

jobs:
  drift:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked

      - name: Run xtask drift
        run: cargo xtask drift

      - name: Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report
          path: target/xtask/drift-report.json

      - name: Capture drift JSON
        id: drift_json
        run: |
          report=$(python3 - <<'PY'
import base64
from pathlib import Path
data = Path("target/xtask/drift-report.json").read_bytes()
print(base64.b64encode(data).decode())
PY
)
          echo "report_b64=$report" >> "$GITHUB_OUTPUT"

      - name: Open or update drift issue
        if: steps.drift_json.outputs.report_b64 != ''
        uses: actions/github-script@v7
        env:
          REPORT_B64: ${{ steps.drift_json.outputs.report_b64 }}
        with:
          script: |
            const report = JSON.parse(Buffer.from(process.env.REPORT_B64, 'base64').toString('utf8'));
            const hasIssues = report.advisories.found || report.transitive_count > report.transitive_limit || report.pin_mismatches.length > 0;
            if (!hasIssues) {
              core.info('No dependency drift detected.');
              return;
            }
            const issueTitle = 'Dependency drift detected';
            const issueBody = [
              `## Drift Summary (${report.timestamp})`,
              '',
              `- Advisories: ${report.advisories.count} (severity: ${Object.entries(report.advisories.severities).map(([k,v]) => `${k}:${v}`).join(', ') || 'none'})`,
              `- Transitive dependencies: ${report.transitive_count} / ${report.transitive_limit}`,
              '',
              '### Pin mismatches',
              report.pin_mismatches.length
                ? report.pin_mismatches.map(m => `- ${m.name}: expected ${m.expected_spec}, resolved ${m.resolved.join(', ')}`).join('\n')
                : '- none',
              '',
              '> Automated report from dependency-drift workflow.'
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: undefined,
              per_page: 100
            });

            const existing = issues.find(issue => issue.title === issueTitle);
            if (existing) {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: issueBody
              });
              core.info(`Updated existing issue #${existing.number}`);
            } else {
              const created = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody
              });
              core.info(`Created issue #${created.data.number}`);
            }
